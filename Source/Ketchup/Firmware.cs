using System;
using Ketchup.Api;

namespace Ketchup
{
    internal sealed class Firmware : IDevice
    {
        #region Constants

        private static readonly ushort[] DefaultFirmware =
        {
            0xa8c1, 0x7ce1, 0x0200, 0x7cd2, 0x0200, 0x7f81, 0x0200, 0x39fe,
            0x9381, 0x1a00, 0x88c3, 0x80d2, 0x7f81, 0x0214, 0x1a20, 0x7c12,
            0x24c5, 0x7c32, 0x4fd5, 0x1bc1, 0x02a7, 0x7c12, 0xf615, 0x7c32,
            0x7349, 0x1bc1, 0x02a8, 0x7f81, 0x0201, 0x83d2, 0x02a7, 0x7f81,
            0x022e, 0x8401, 0x7a40, 0x02a7, 0x8432, 0x7f81, 0x0238, 0x8c01,
            0x8461, 0x8481, 0x7a40, 0x02a7, 0x8833, 0x7f81, 0x0242, 0x8401,
            0x7a40, 0x02a7, 0x8832, 0x7f81, 0x025e, 0x7f81, 0x0226, 0x83d2,
            0x02a8, 0x7f81, 0x025c, 0x7c20, 0x024b, 0x7cc1, 0x0267, 0x7f81,
            0x0251, 0x83d2, 0x02a8, 0x7f81, 0x025c, 0x7c20, 0x024b, 0x7cc1,
            0x027f, 0x7f81, 0x0251, 0x83d2, 0x02a8, 0x8b83, 0x7c20, 0x024b,
            0x7cc1, 0x0296, 0x7f81, 0x0251, 0x8401, 0x7c21, 0x8000, 0x7a40,
            0x02a8, 0x6381, 0x7ce1, 0x8000, 0x85d2, 0x7f81, 0x025c, 0x3841,
            0x7c4b, 0xf000, 0x09fe, 0x7f81, 0x0253, 0x7f81, 0x025c, 0x8401,
            0x8421, 0x8441, 0x8461, 0x8481, 0x84c1, 0x84e1, 0x8761, 0x8781,
            0x0041, 0x0054, 0x0054, 0x0041, 0x0043, 0x0048, 0x0020, 0x004d,
            0x0033, 0x0035, 0x0046, 0x0044, 0x0020, 0x0041, 0x004e, 0x0044,
            0x0020, 0x0052, 0x0045, 0x0042, 0x004f, 0x004f, 0x0054, 0x0000,
            0x0049, 0x004e, 0x0053, 0x0045, 0x0052, 0x0054, 0x0020, 0x0044,
            0x0049, 0x0053, 0x004b, 0x0020, 0x0041, 0x004e, 0x0044, 0x0020,
            0x0052, 0x0045, 0x0042, 0x004f, 0x004f, 0x0054, 0x0000, 0x0044,
            0x0052, 0x0049, 0x0056, 0x0045, 0x0020, 0x0052, 0x0045, 0x0041,
            0x0044, 0x0020, 0x0045, 0x0052, 0x0052, 0x004f, 0x0052, 0x0000,
            0xffff, 0xffff 
        };

        #endregion

        #region Instance Fields

        private IDcpu16 _dcpu16;

        #endregion

        #region Device Identifiers

        // TODO: The proposed specifications do not mention any specifics for these

        public string FriendlyName
        {
            get { return "DCPU-16 Firmware"; }
        }

        public uint ManufacturerId
        {
            get { return (uint)Constants.ManufacturerId.Unknown; }
        }

        public uint DeviceId
        {
            get { return (uint)Constants.DeviceId.Firmware; }
        }

        public ushort Version
        {
            get { return 0x0001; }
        }

        #endregion

        #region IDevice Methods

        public void OnConnect(IDcpu16 dcpu16)
        {
            _dcpu16 = dcpu16;
        }

        public void OnDisconnect()
        {
            _dcpu16 = null;
        }

        public int OnInterrupt()
        {
            if (_dcpu16 != null)
            {
                Array.Copy(DefaultFirmware, 0, _dcpu16.Memory, _dcpu16.B, DefaultFirmware.Length);
            }

            return 0;
        }

        #endregion
    }
}
